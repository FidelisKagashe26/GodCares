<!DOCTYPE html>
<html lang="sw" class="h-full accent-green">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}GOD CARES 365 - Tovuti ya Kiroho{% endblock %}</title>
  <meta name="description" content="{% block description %}Tovuti ya kiroho yenye masomo ya Biblia, maombi, na rasilimali za imani{% endblock %}">
  <meta name="keywords" content="{% block keywords %}kiroho, biblia, maombi, imani, tanzania, masomo{% endblock %}">
  {% load static %}

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { 
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          boxShadow: {
            square: '0 6px 0 0 rgba(0,0,0,0.06)',
            squareHover: '0 8px 0 0 rgba(0,0,0,0.10)',
            focus: '0 0 0 3px var(--accent-200)'
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style type="text/tailwindcss">
    /* -------- Accent palettes -------- */
    html.accent-green { 
      --accent-50:#ECFDF5; --accent-100:#D1FAE5; --accent-200:#A7F3D0; 
      --accent-400:#34D399; --accent-500:#10B981; --accent-600:#059669; --accent-700:#047857; 
    }
    html.accent-blue { 
      --accent-50:#EFF6FF; --accent-100:#DBEAFE; --accent-200:#BFDBFE; 
      --accent-400:#60A5FA; --accent-500:#3B82F6; --accent-600:#2563EB; --accent-700:#1D4ED8; 
    }
    html.accent-yellow { 
      --accent-50:#FFFBEB; --accent-100:#FEF3C7; --accent-200:#FDE68A; 
      --accent-400:#FBBF24; --accent-500:#F59E0B; --accent-600:#D97706; --accent-700:#B45309; 
    }

    /* Subtle grid background */
    body::before {
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        linear-gradient(to right, rgba(0,0,0,.035) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,.035) 1px, transparent 1px);
      background-size:32px 32px;
    }
    .dark body::before {
      background-image:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
    }

    .top-accent { height:3px; background:var(--accent-600); }
    .page-container { @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8; }

    .card { 
      @apply relative bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-800 
             rounded-none shadow-square transition-shadow; 
    }
    .card:hover { @apply shadow-squareHover; }
    .card::before { 
      content:""; position:absolute; left:0; right:0; top:0; 
      height:3px; background:var(--accent-600); 
    }

    .btn-primary { 
      background:var(--accent-600); border-color:var(--accent-700); 
      @apply rounded-none font-semibold px-5 lg:px-7 py-2.5 text-sm lg:text-base 
             text-white border-2 transition-all hover:scale-[1.02]; 
    }
    .btn-primary:hover { background:var(--accent-700); }
    
    .btn-secondary { 
      @apply rounded-none font-semibold px-5 lg:px-7 py-2.5 text-sm lg:text-base
             bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 
             border-2 border-gray-300 dark:border-gray-700 transition-all hover:scale-[1.02]; 
    }
    .btn-secondary:focus, .btn-primary:focus { 
      box-shadow: var(--tw-shadow,0 0 #0000), 0 0 0 3px var(--accent-200); 
    }

    /* -------- NAV LINKS -------- */
    .nav-link {
      @apply relative grid grid-flow-col auto-cols-max items-center gap-2
             px-4 py-2.5 rounded-none text-sm font-semibold tracking-wide
             text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white
             transition-colors;
    }
    .nav-link.active { 
      @apply text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800; 
    }
    .nav-link:hover {
      @apply bg-gray-50 dark:bg-gray-800/50;
    }

    /* User Avatar */
    .user-avatar { 
      @apply w-8 h-8 lg:w-9 lg:h-9 grid place-items-center rounded-full 
             font-extrabold text-white text-xs lg:text-sm; 
      background: var(--accent-600); 
      border: 2px solid color-mix(in oklab, var(--accent-600) 70%, black 20%); 
    }

    /* Dropdown Menu */
    .dropdown { @apply relative; }
    .topbar { @apply transition-all duration-200 isolate; overflow: visible; }
    .dropdown-panel {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(8px);
      min-width: 14rem;
      max-width: 18rem;        /* limit width so User menu is not too wide */
      width: auto;
      z-index: 1200;
      display: none;
      @apply card p-2;
      margin: 0;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,.12));
      will-change: transform, opacity;
      max-height: calc(100vh - 160px); /* prevent overly tall panels */
      overflow: auto;                    /* scroll when content exceeds height */
    }
    .dropdown-panel.dropdown-right { right: 0; left: auto; transform: translateY(8px); }
    .dropdown-panel.dropdown-center { left: 50%; transform: translateX(-50%) translateY(8px); }
    .dropdown.open .dropdown-panel {
      display: block;
      transform: translateX(-50%) translateY(0);
    }
    .menu-item {
      @apply grid grid-flow-col auto-cols-max items-center gap-3 px-3 py-2.5
             text-sm font-medium text-gray-700 dark:text-gray-300
             hover:bg-gray-100 dark:hover:bg-gray-800 rounded-none transition-colors;
    }

    /* Topbar styles */
    .topbar { @apply transition-all duration-200 isolate; }
    .topbar.scrolled { box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    
    #scroll-progress { 
      @apply fixed top-0 left-0 h-1 z-[60]; 
      width:0; background: var(--accent-600); 
      transition: width 0.1s ease-out;
    }

    /* Main content spacing */
    main { @apply mt-[120px] lg:mt-[136px]; }
    .content-frame { 
      @apply relative border-2 border-gray-200 dark:border-gray-800 
             bg-white/70 dark:bg-gray-900/70 backdrop-blur p-4 sm:p-6 lg:p-10; 
    }
    .content-frame::after { 
      content:""; position:absolute; left:-8px; top:-8px; 
      width:18px; height:18px; background:var(--accent-600); 
      box-shadow: 14px 0 0 0 color-mix(in oklab, var(--accent-600) 80%, black 0%), 
                  0 14px 0 0 color-mix(in oklab, var(--accent-600) 60%, black 0%); 
    }

    /* Footer */
    .footer-col { 
      @apply border-2 border-transparent 
             lg:border-l-2 lg:border-l-gray-800 rounded-none; 
    }
    .footer-title { 
      @apply text-lg lg:text-xl font-extrabold text-white tracking-wide; 
    }

    /* Mobile / Tablet NAV */
    #mobile-menu {
      @apply lg:hidden border-t-2 border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950;
      max-height: 0;
      overflow: hidden;
      transition: max-height .28s ease, visibility .18s;
      box-sizing: border-box;
      visibility: hidden;
    }
    #mobile-menu.open {
      max-height: calc(100vh - 64px); /* leave space for topbar */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      visibility: visible;
      padding-bottom: env(safe-area-inset-bottom); /* safe area on phones */
    }

    /* Keep the search header sticky inside the menu */
    #mobile-menu .sticky { position: sticky; top: 0; z-index: 20; background: inherit; }

    /* Mobile links */
    .mobile-nav-link {
      @apply grid grid-flow-col auto-cols-max items-center gap-3 px-4 py-3.5 text-sm sm:text-base font-semibold text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 transition-colors active:bg-gray-100 dark:active:bg-gray-800;
      min-height: 48px;
    }
    .mobile-nav-link i { color: var(--accent-600); }
    .mobile-nav-link:last-of-type { border-bottom: none; }

    /* Make sure account/logout area is separated and visible */
    #mobile-menu .mobile-subtitle { z-index: 15; }
    #mobile-menu form { border-bottom: 0; }

    /* Optional: body lock class (JS can toggle when menu opens) */
    body.mobile-menu-open { overflow: hidden; }
    
    .mobile-subtitle { 
      @apply px-4 pt-3 pb-1 text-xs uppercase tracking-wider font-bold
             text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900; 
    }

    /* Search Input Styles */
    .search-input {
      @apply pl-10 pr-4 py-2.5 w-full border-2 
             border-gray-300 dark:border-gray-700 
             bg-white dark:bg-gray-900 
             text-gray-900 dark:text-white
             rounded-none transition-all
             focus:outline-none focus:ring-0 focus:border-[var(--accent-600)];
    }

    /* Responsive Typography */
    @media (max-width: 640px) {
      html { font-size: 14px; }
      .brand-text { @apply text-base font-extrabold tracking-wider; }
      main { margin-top: 64px; }
    }
    /* Search Button */
    .search-btn {
      @apply px-4 py-2.5 font-semibold text-sm lg:text-base
            text-white border-2 rounded-none transition-all
            hover:scale-[1.02] focus:outline-none;
      background: var(--accent-600);
      border-color: var(--accent-700);
    }
    .search-btn:hover {
      background: var(--accent-700);
    }

  </style>

  {% block extra_css %}{% endblock %}
</head>

<body class="h-full bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-white font-sans">
  <div id="scroll-progress"></div>

  <!-- NAVIGATION BAR -->
  <nav id="topbar" class="topbar fixed top-0 inset-x-0 z-50 bg-white/95 dark:bg-gray-950/95 backdrop-blur-sm border-b-2 border-gray-200 dark:border-gray-800">
    <div class="top-accent"></div>
    <div class="page-container">
      
      <!-- Row 1: Logo + Search + Actions (Desktop) -->
      <div class="grid grid-cols-[auto,1fr,auto] items-center h-16 lg:h-18 gap-3 lg:gap-4">
        
        <!-- BRAND / LOGO -->
        <a href="{% url 'home' %}" class="grid grid-flow-col auto-cols-max items-center gap-2 lg:gap-3 hover:opacity-80 transition-opacity">
          <img src="{% static 'images/logo.png' %}" alt="GOD CARES 365" class="h-8 lg:h-10 w-auto select-none" />
          <span class="brand-text hidden sm:inline font-extrabold text-lg lg:text-2xl tracking-wider">
            <span class="text-yellow-500">GOD</span> 
            <span class="text-blue-600">CARES</span> 
            <span class="text-green-700">365</span>
          </span>
        </a>

        <!-- CENTER: Search Bar (Desktop only) -->
        <div class="hidden lg:grid justify-items-center">
          <form action="{% url 'site_search' %}" method="get" class="w-full max-w-xl">
            <div class="relative">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input name="search" type="search" 
                     placeholder="Tafuta masomo, makala, matukio..."
                     class="search-input">
            </div>
          </form>
        </div>

        <!-- RIGHT: User Actions -->
        <div class="grid grid-flow-col auto-cols-max items-center gap-2 lg:gap-3 justify-self-end">
          
          {% if request.user.is_authenticated %}
            {% with name=request.user.first_name|default:request.user.username %}
            {% with initials=name|slice:":2"|upper %}
            
            <!-- User Dropdown (Desktop) -->
            <div class="dropdown group hidden lg:block">
              <button type="button" data-dropdown-trigger aria-haspopup="true" aria-expanded="false"
                      class="grid grid-flow-col auto-cols-max items-center gap-2 px-3 py-2 border-2 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-none transition-colors">
                <div class="user-avatar">{{ initials }}</div>
                <span class="font-semibold truncate max-w-[8rem]">{{ name }}</span>
                <i class="fas fa-chevron-down text-xs opacity-70" aria-hidden="true"></i>
              </button>
              <div class="dropdown-panel dropdown-right" role="menu" aria-label="Account menu">
                <div class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 mb-1">
                  Umeingia kama <span class="font-semibold text-gray-800 dark:text-gray-100">{{ name }}</span>
                </div>

                {% if request.user.is_staff or request.user.is_superuser %}
                <a href="{% url 'admin:index' %}" class="menu-item" role="menuitem" tabindex="0">
                  <i class="fas fa-tachometer-alt"></i>
                  <span>Dashboard</span>
                </a>
                {% endif %}

                <a href="{% url 'notifications_inbox' %}" class="menu-item" role="menuitem" tabindex="0">
                  <i class="fa-solid fa-envelope-open-text"></i>
                  <span>Jumbe</span>
                  {% if request.user.is_authenticated %}
                    {% with unread=notif_unread_count %}
                      <span data-notif-badge
                            class="{% if unread == 0 %}hidden{% endif %} ml-auto min-w-[1.5rem] h-6 px-1 grid place-items-center rounded-full bg-red-600 text-white text-[12px] leading-none">
                        {{ unread }}
                      </span>
                    {% endwith %}
                  {% endif %}
                </a>

                <a href="{% url 'account_profile' %}" class="menu-item" role="menuitem" tabindex="0">
                  <i class="fa-solid fa-user-pen"></i>
                  <span>Hariri Wasifu</span>
                </a>
                <a href="{% url 'password_change' %}" class="menu-item" role="menuitem" tabindex="0">
                  <i class="fa-solid fa-key"></i>
                  <span>Badili Nenosiri</span>
                </a>
                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                <form method="post" action="{% url 'logout' %}" role="none">
                  {% csrf_token %}
                  <button type="submit" class="menu-item w-full text-red-600 dark:text-red-400" role="menuitem">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Toka</span>
                  </button>
                </form>
              </div>
            </div>

            {% endwith %}
            {% endwith %}
          {% else %}
            
            <!-- Login/Signup Buttons (Desktop) -->
            <div class="hidden lg:grid grid-flow-col auto-cols-max gap-2">
              <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" 
                 class="btn-secondary">
                <i class="fas fa-sign-in-alt mr-2"></i>
                <span>Ingia</span>
              </a>
              <a href="{% url 'content:signup' %}?next={{ request.get_full_path|urlencode }}" 
                 class="btn-primary">
                <i class="fas fa-user-plus mr-2"></i>
                <span>Jisajili</span>
              </a>
            </div>

          {% endif %}

          <!-- Theme Toggle (Always Visible) -->
          <button id="theme-toggle" 
                  class="p-2.5 border-2 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-none transition-colors" 
                  aria-label="Toggle theme">
            <span id="theme-icon-sun" class="hidden" style="color:var(--accent-600)">
              <i class="fas fa-sun text-lg"></i>
            </span>
            <span id="theme-icon-moon" class="hidden" style="color:var(--accent-400)">
              <i class="fas fa-moon text-lg"></i>
            </span>
          </button>

          <!-- Mobile Menu Button (<1024px) -->
          <button id="mobile-menu-btn" 
                  class="lg:hidden p-2.5 border-2 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-none transition-colors" 
                  aria-controls="mobile-menu" 
                  aria-expanded="false">
            <i class="fas fa-bars text-lg"></i>
          </button>
        </div>
      </div>

      <!-- Row 2: Navigation Links (Desktop only) -->
      <div class="hidden lg:grid border-t border-gray-200 dark:border-gray-800">
        <div class="grid auto-cols-max grid-flow-col items-stretch gap-1 justify-center py-2">
          
          <a href="{% url 'home' %}" 
             class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>Nyumbani</span>
          </a>
          
          <a href="{% url 'about' %}" 
             class="nav-link {% if request.resolver_match.url_name == 'about' %}active{% endif %}">
            <i class="fas fa-info-circle"></i>
            <span>Kuhusu Sisi</span>
          </a>

          <!-- HABARI Dropdown -->
          <div class="dropdown group">
            <button type="button" 
                    class="nav-link {% if 'news' in request.resolver_match.url_name or request.resolver_match.url_name == 'events' %}active{% endif %}" 
                    data-dropdown-trigger>
              <i class="fas fa-newspaper"></i>
              <span>Habari</span>
              <i class="fas fa-chevron-down text-xs opacity-70"></i>
            </button>
            <div class="dropdown-panel" style="left: 50%; transform: translateX(-50%); right: auto;">
              <a href="{% url 'news' %}" class="menu-item">
                <i class="fa-solid fa-book-open"></i>
                <span>Makala</span>
              </a>
              <a href="{% url 'events' %}" class="menu-item">
                <i class="fa-solid fa-calendar-days"></i>
                <span>Matukio</span>
              </a>
            </div>
          </div>

          <a href="{% url 'bible_studies' %}" 
             class="nav-link {% if 'bible' in request.resolver_match.url_name %}active{% endif %}">
            <i class="fas fa-book"></i>
            <span>Mafunzo ya Biblia</span>
          </a>

          <a href="{% url 'prayer_requests' %}" 
             class="nav-link {% if request.resolver_match.url_name == 'prayer_requests' %}active{% endif %}">
            <i class="fas fa-heart"></i>
            <span>Maombi</span>
          </a>

          <a href="{% url 'donations' %}" 
             class="nav-link {% if request.resolver_match.url_name == 'donations' %}active{% endif %}">
            <i class="fas fa-donate"></i>
            <span>Michango</span>
          </a>

        </div>
      </div>

      <!-- MOBILE MENU (<1024px) -->
      <div id="mobile-menu">
        
        <!-- Search (Mobile) -->
        <div class="px-4 py-3 bg-gray-50 dark:bg-gray-900 border-b-2 border-gray-200 dark:border-gray-800 sticky top-0 z-10">
          <form action="{% url 'site_search' %}" method="get" data-keep-open>
            <div class="relative">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input name="search" type="search" 
                     placeholder="Tafuta masomo, makala..."
                     class="search-input">
            </div>
          </form>
        </div>

        <!-- Navigation Links -->
        <a href="{% url 'home' %}" class="mobile-nav-link">
          <i class="fas fa-home"></i>
          <span>Nyumbani</span>
        </a>
        
        <a href="{% url 'about' %}" class="mobile-nav-link">
          <i class="fas fa-info-circle"></i>
          <span>Kuhusu Sisi</span>
        </a>
        
        <a href="{% url 'bible_studies' %}" class="mobile-nav-link">
          <i class="fas fa-book"></i>
          <span>Mafunzo ya Biblia</span>
        </a>
        
        <a href="{% url 'prayer_requests' %}" class="mobile-nav-link">
          <i class="fas fa-heart"></i>
          <span>Maombi ya Pamoja</span>
        </a>
        
        <a href="{% url 'donations' %}" class="mobile-nav-link">
          <i class="fas fa-donate"></i>
          <span>Michango</span>
        </a>

        <!-- HABARI Section -->
        <div class="mobile-subtitle">HABARI</div>
        <a href="{% url 'news' %}" class="mobile-nav-link">
          <i class="fa-solid fa-book-open"></i>
          <span>Makala</span>
        </a>
        <a href="{% url 'events' %}" class="mobile-nav-link">
          <i class="fa-solid fa-calendar-days"></i>
          <span>Matukio</span>
        </a>

        <!-- AKAUNTI Section -->
        {% if request.user.is_authenticated %}
          <div class="mobile-subtitle">AKAUNTI</div>
          {% with name=request.user.first_name|default:request.user.username %}
          {% with initials=name|slice:":2"|upper %}
          
          <div class="mobile-nav-link bg-gray-50 dark:bg-gray-900">
            <div class="user-avatar">{{ initials }}</div>
            <span class="truncate">{{ name }}</span>
          </div>
          
          {% endwith %}
          {% endwith %}
          
          <a href="{% url 'notifications_inbox' %}" class="menu-item" role="menuitem" tabindex="0">
            <i class="fa-solid fa-envelope-open-text"></i>
            <span>Jumbe</span>
            <span data-notif-badge
                  class="hidden ml-auto min-w-[1.5rem] h-6 px-1 grid place-items-center rounded-full bg-red-600 text-white text-[12px] leading-none"></span>
          </a>

          <a href="{% url 'account_profile' %}" class="mobile-nav-link">
            <i class="fa-solid fa-user-pen"></i>
            <span>Hariri Wasifu</span>
          </a>
          
          <a href="{% url 'password_change' %}" class="mobile-nav-link">
            <i class="fa-solid fa-key"></i>
            <span>Badili Nenosiri</span>
          </a>
          
          <form method="post" action="{% url 'logout' %}" class="border-b border-gray-200 dark:border-gray-800">
            {% csrf_token %}
            <button type="submit" class="mobile-nav-link w-full text-red-600 dark:text-red-400">
              <i class="fas fa-sign-out-alt"></i>
              <span>Toka (Logout)</span>
            </button>
          </form>
        {% else %}
          <div class="mobile-subtitle">AKAUNTI</div>
          
          <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" 
             class="mobile-nav-link">
            <i class="fas fa-sign-in-alt"></i>
            <span>Ingia (Login)</span>
          </a>
          
          <a href="{% url 'content:signup' %}?next={{ request.get_full_path|urlencode }}" 
             class="mobile-nav-link">
            <i class="fas fa-user-plus"></i>
            <span>Jisajili (Sign Up)</span>
          </a>
        {% endif %}
      </div>

    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="min-h-screen">
    <div class="page-container py-5 lg:py-8">
      <div class="content-frame">
        <div class="grid grid-cols-1 gap-4 lg:gap-6">
          {% block content %}{% endblock %}
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-950 text-gray-300 border-t-8 border-gray-800">
    <div class="top-accent"></div>
    <div class="page-container py-10 lg:py-12">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 lg:gap-6">
        
        <!-- About Column -->
        <div class="footer-col lg:border-l-0 lg:pl-0">
          <div class="grid grid-flow-col auto-cols-max items-center gap-3 mb-4">
            <img src="{% static 'images/logo.png' %}" alt="GOD CARES 365" class="h-8 w-auto">
            <h3 class="footer-title">
              <span class="text-yellow-500">GOD</span> 
              <span class="text-blue-600">CARES</span> 
              <span class="text-green-700">365</span>
            </h3>
          </div>
          <p class="text-sm lg:text-base mb-4">Tovuti hii imeundwa kukuimarisha katika imani, kukuunga mkono katika maombi, na kukupeleka karibu na Mungu.</p>
          <div class="grid grid-flow-col auto-cols-max gap-4">
            <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Facebook">
              <i class="fab fa-facebook text-xl"></i>
            </a>
            <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Twitter">
              <i class="fab fa-twitter text-xl"></i>
            </a>
            <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Instagram">
              <i class="fab fa-instagram text-xl"></i>
            </a>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="footer-col sm:pl-0 lg:pl-6">
          <h3 class="footer-title mb-4">Viungo vya Haraka</h3>
          <ul class="space-y-2 text-sm lg:text-base">
            <li><a href="{% url 'home' %}" class="hover:text-white transition-colors">Nyumbani</a></li>
            <li><a href="{% url 'about' %}" class="hover:text-white transition-colors">Kuhusu Sisi</a></li>
            <li><a href="{% url 'news' %}" class="hover:text-white transition-colors">Makala</a></li>
            <li><a href="{% url 'events' %}" class="hover:text-white transition-colors">Matukio</a></li>
            <li><a href="{% url 'bible_studies' %}" class="hover:text-white transition-colors">Mafunzo</a></li>
            <li><a href="{% url 'prayer_requests' %}" class="hover:text-white transition-colors">Maombi</a></li>
          </ul>
        </div>

        <!-- Services -->
        <div class="footer-col sm:pl-0 lg:pl-6">
          <h3 class="footer-title mb-4">Huduma Zetu</h3>
          <ul class="space-y-2 text-sm lg:text-base">
            <li><a href="{% url 'bible_studies' %}" class="hover:text-white transition-colors">Masomo ya Biblia</a></li>
            <li><a href="{% url 'prayer_requests' %}" class="hover:text-white transition-colors">Maombi ya Pamoja</a></li>
            <li><a href="{% url 'events' %}" class="hover:text-white transition-colors">Matukio ya Kiroho</a></li>
            <li><a href="{% url 'donations' %}" class="hover:text-white transition-colors">Michango</a></li>
          </ul>
        </div>

        <!-- Contact -->
        <div class="footer-col sm:pl-0 lg:pl-6">
          <h3 class="footer-title mb-4">Wasiliana Nasi</h3>
          <div class="space-y-3 text-sm lg:text-base">
            <div class="grid grid-flow-col auto-cols-max items-start gap-3">
              <i class="fas fa-envelope mt-1" style="color:var(--accent-400)"></i>
              <span>fmklink@gmail.com</span>
            </div>
            <div class="grid grid-flow-col auto-cols-max items-start gap-3">
              <i class="fas fa-phone mt-1" style="color:var(--accent-400)"></i>
              <span>+255 767 525 234</span>
            </div>
            <div class="grid grid-flow-col auto-cols-max items-start gap-3">
              <i class="fas fa-map-marker-alt mt-1" style="color:var(--accent-400)"></i>
              <span>Dar es Salaam, Tanzania</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-8 lg:mt-10 pt-6 lg:pt-8 border-t-2 border-gray-800 text-center text-sm text-gray-400">
        &copy; {{ current_year }} GOD CARES 365. Haki zote zimehifadhiwa.
      </div>
    </div>
  </footer>

  <!-- JAVASCRIPT -->
  <script>
    // Theme Management
    const html = document.documentElement;
    const themeBtn = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const topbar = document.getElementById('topbar');
    const mobileBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const progress = document.getElementById('scroll-progress');

    // Initialize theme
    const savedTheme = localStorage.getItem('gc-theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      html.classList.add('dark');
    }
    updateThemeIcons();

    // Theme toggle
    themeBtn?.addEventListener('click', () => {
      html.classList.toggle('dark');
      localStorage.setItem('gc-theme', html.classList.contains('dark') ? 'dark' : 'light');
      updateThemeIcons();
    });

    function updateThemeIcons() {
      const isDark = html.classList.contains('dark');
      if (sunIcon) sunIcon.style.display = isDark ? 'none' : 'inline-block';
      if (moonIcon) moonIcon.style.display = isDark ? 'inline-block' : 'none';
    }

    /* Desktop dropdown: render panels as fixed overlays so they don't push layout */
    function measureAndPlace(panel, trigger) {
      // show invisibly to measure
      panel.style.visibility = 'hidden';
      panel.style.display = 'block';
      panel.style.position = 'fixed';
      panel.style.transform = 'none';
      panel.style.left = '0';
      panel.style.top = '0';

      const trgRect = trigger.getBoundingClientRect();
      const panelRect = panel.getBoundingClientRect();
      // center panel on trigger by default, adjust if overflows viewport
      let left = Math.round(trgRect.left + (trgRect.width / 2) - (panelRect.width / 2));
      const spacing = 8; // gap between trigger and panel
      let top = Math.round(trgRect.bottom + spacing);

      // keep within viewport horizontally
      const minLeft = 8;
      const maxLeft = window.innerWidth - panelRect.width - 8;
      if (left < minLeft) left = minLeft;
      if (left > maxLeft) left = maxLeft;

      // if not enough space below, show above
      if (top + panelRect.height > window.innerHeight - 8) {
        top = Math.round(trgRect.top - panelRect.height - spacing);
      }

      panel.style.left = left + 'px';
      panel.style.top = top + 'px';
      panel.style.visibility = '';
    }

    function openDropdown(dropdown, trigger, panel) {
      // mark
      dropdown.classList.add('open');
      trigger.setAttribute('aria-expanded', 'true');
      // position as fixed overlay
      panel.style.position = 'fixed';
      panel.style.transform = 'none';
      panel.style.display = 'block';
      measureAndPlace(panel, trigger);
      // mark currently open
      document.querySelectorAll('.dropdown.open').forEach(dd => {
        if (dd !== dropdown) {
          dd.classList.remove('open');
          const t = dd.querySelector('[data-dropdown-trigger]');
          if (t) t.setAttribute('aria-expanded', 'false');
          const p = dd.querySelector('.dropdown-panel');
          if (p) p.style.display = 'none';
        }
      });
    }

    function closeDropdown(dropdown) {
      const trigger = dropdown.querySelector('[data-dropdown-trigger]');
      const panel = dropdown.querySelector('.dropdown-panel');
      dropdown.classList.remove('open');
      if (trigger) trigger.setAttribute('aria-expanded', 'false');
      if (panel) {
        panel.style.display = 'none';
        // remove fixed positioning so original stylesheet still applies when reopened
        panel.style.position = '';
        panel.style.left = '';
        panel.style.top = '';
        panel.style.transform = '';
      }
    }

    // attach handlers
    document.querySelectorAll('[data-dropdown-trigger]').forEach(btn => {
      const dropdown = btn.closest('.dropdown');
      if (!dropdown) return;
      const panel = dropdown.querySelector('.dropdown-panel');

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = dropdown.classList.contains('open');
        if (isOpen) {
          closeDropdown(dropdown);
        } else {
          openDropdown(dropdown, btn, panel);
        }
      });

      // reposition on window events if open
      ['resize', 'scroll'].forEach(ev => {
        window.addEventListener(ev, () => {
          if (dropdown.classList.contains('open')) {
            // small throttle
            window.requestAnimationFrame(() => measureAndPlace(panel, btn));
          }
        }, { passive: true });
      });
    });

    // Close on outside click or Escape
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown.open').forEach(dd => closeDropdown(dd));
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.dropdown.open').forEach(dd => closeDropdown(dd));
      }
    });

    // Mobile menu toggle
    function toggleMobileMenu(forceState) {
      const shouldOpen = forceState !== undefined ? forceState : !mobileMenu.classList.contains('open');
      
      if (shouldOpen) {
        mobileMenu.classList.add('open');
        mobileBtn?.setAttribute('aria-expanded', 'true');
      } else {
        mobileMenu.classList.remove('open');
        mobileBtn?.setAttribute('aria-expanded', 'false');
      }
    }

    mobileBtn?.addEventListener('click', () => toggleMobileMenu());

    // Close mobile menu on link click (except search)
    mobileMenu?.addEventListener('click', (e) => {
      if (e.target.closest('a, button[type="submit"]') && !e.target.closest('[data-keep-open]')) {
        toggleMobileMenu(false);
      }
    });

    // Auto-close mobile menu on resize to desktop
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth >= 1024) {
          toggleMobileMenu(false);
        }
      }, 250);
    });

    // Scroll effects
    function handleScroll() {
      const scrollY = window.scrollY || document.documentElement.scrollTop;
      
      // Topbar shadow
      topbar?.classList.toggle('scrolled', scrollY > 2);
      
      // Progress bar
      const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrollPercent = docHeight > 0 ? (scrollY / docHeight) * 100 : 0;
      progress.style.width = scrollPercent + '%';
    }

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
  </script>

  {% if messages %}
  <!-- Toast Notifications -->
  <div id="toast-wrap" class="fixed top-20 right-4 z-[9999] grid gap-2 max-w-sm">
    {% for message in messages %}
      <div class="px-4 py-3 rounded-none border-2 shadow-lg
                  {% if message.tags == 'success' %}bg-green-50 border-green-600 text-green-800 dark:bg-green-900 dark:text-green-100
                  {% elif message.tags == 'error' %}bg-red-50 border-red-600 text-red-800 dark:bg-red-900 dark:text-red-100
                  {% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-600 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100
                  {% else %}bg-blue-50 border-blue-600 text-blue-800 dark:bg-blue-900 dark:text-blue-100{% endif %}">
        <div class="grid grid-flow-col auto-cols-max items-start gap-2">
          <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} mt-0.5"></i>
          <span class="text-sm font-medium">{{ message }}</span>
        </div>
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      const toastWrap = document.getElementById('toast-wrap');
      if (!toastWrap) return;
      toastWrap.style.transition = 'opacity .4s ease';
      toastWrap.style.opacity = '0';
      setTimeout(() => toastWrap.remove(), 450);
    }, 4000);
  </script>
  {% endif %}

  <!-- Loading Overlay -->
  <div id="page-loader" class="fixed inset-0 hidden bg-black/40 backdrop-blur-sm z-[9998]">
    <div class="absolute inset-0 grid place-items-center">
      <div class="grid gap-3 text-center">
        <div class="w-12 h-12 border-4 border-white/40 border-t-white rounded-full animate-spin mx-auto"></div>
        <span class="text-white font-semibold">Inapakia...</span>
      </div>
    </div>
  </div>
  
  <script>
    // Form submission loader
    document.addEventListener('submit', function(e) {
      const form = e.target;
      if (!form.matches('form[data-prevent-double-submit]')) return;
      
      const submitBtn = form.querySelector('[data-submit-btn]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.dataset.originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full animate-spin mr-2"></span>Inatuma...';
      }
      
      document.getElementById('page-loader')?.classList.remove('hidden');
    }, true);
  </script>
  <script>
    // === Notifications badge (polling kidogo) ===
    async function refreshNotifBadge() {
      try {
        const res = await fetch("{% url 'api_unread_count' %}", { headers: { "X-Requested-With": "XMLHttpRequest" } });
        if (!res.ok) return;
        const data = await res.json();
        const c = Number(data.count || 0);
        document.querySelectorAll('[data-notif-badge]').forEach(el => {
          if (c > 0) {
            el.textContent = c > 99 ? "99+" : String(c);
            el.style.display = "grid";
          } else {
            el.style.display = "none";
            el.textContent = "";
          }
        });
      } catch (e) { /* kimya */ }
    }
    window.addEventListener("load", refreshNotifBadge);
    document.addEventListener("visibilitychange", () => { if (!document.hidden) refreshNotifBadge(); });
    setInterval(refreshNotifBadge, 60000); // kila 60s
  </script>

  <script>
    (function(){
      const badge = document.querySelector("[data-notif-badge]");
      if (!badge) return;
      function refreshBadge(){
        fetch("{% url 'notifications_unread_count' %}", {headers: {"X-Requested-With": "fetch"}})
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (!data) return;
            const n = data.count || 0;
            if (n > 0) {
              badge.textContent = n;
              badge.classList.remove("hidden");
            } else {
              badge.classList.add("hidden");
            }
          })
          .catch(()=>{});
      }
      refreshBadge();
      setInterval(refreshBadge, 60000);
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
